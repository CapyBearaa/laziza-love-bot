import random
import logging
import json
import os
from datetime import datetime, time, date

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
)

TOKEN = os.getenv("TOKEN")
ALLOWED_CHAT_ID = 905959081

MORNING_TIME = time(hour=9, minute=0)
EVENING_TIME = time(hour=23, minute=0)

START_RELATIONSHIP = date(2025, 8, 1)

MEMORY_FILE = "memory.json"

logging.basicConfig(level=logging.INFO)

normal_phrases = [
"–õ–∞–∑–∏–∑–∞, —Å —Ç–æ–±–æ–π –º–∏—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º—è–≥—á–µ.",
"–Ø –ª—é–±–ª—é, –∫–∞–∫ —Ç—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ –º–µ–Ω—è.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–æ–∏ –¥–Ω–∏ —Ç–µ–ø–ª–µ–µ.",
"–° —Ç–æ–±–æ–π –º–Ω–µ —Å–ø–æ–∫–æ–π–Ω–æ.",
"–Ø –≤—ã–±–∏—Ä–∞—é —Ç–µ–±—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π —Ç—ë–ø–ª—ã–π —á–µ–ª–æ–≤–µ–∫.",
"–Ø –¥—É–º–∞—é –æ —Ç–µ–±–µ —á–∞—â–µ, —á–µ–º –≥–æ–≤–æ—Ä—é.",
"–¢—ã –º–æ—è —Ä–∞–¥–æ—Å—Ç—å.",
"–° —Ç–æ–±–æ–π —è —á—É–≤—Å—Ç–≤—É—é —Å–µ–±—è –¥–æ–º–∞.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ—é —É–ª—ã–±–∫—É.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è –ª—É—á—à–µ.",
"–ú–Ω–µ —Ö–æ—Ä–æ—à–æ —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π.",
"–¢—ã –º–æ–π —Å–º—ã—Å–ª.",
"–Ø —Ü–µ–Ω—é —Ç–µ–±—è.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–æ–∏ –º—ã—Å–ª–∏ —Å–≤–µ—Ç–ª–µ–µ.",
"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Ç–µ–±–µ.",
"–¢—ã –º–æ—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ–π —Å–º–µ—Ö.",
"–¢—ã –º–æ—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å.",
"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –±—ã—Ç—å —Å —Ç–æ–±–æ–π.",
"–¢—ã –º–æ–π –ø–æ–∫–æ–π.",
"–Ø —Å–∫—É—á–∞—é –ø–æ —Ç–µ–±–µ.",
"–¢—ã –æ—Å–æ–±–µ–Ω–Ω–∞—è –¥–ª—è –º–µ–Ω—è.",
"–ú–Ω–µ –≤–∞–∂–Ω–æ —Ç–≤–æ—ë —Å—á–∞—Å—Ç—å–µ.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è —Å–∏–ª—å–Ω–µ–µ.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ–∏ –≥–ª–∞–∑–∞.",
"–¢—ã –º–æ–π —Å–≤–µ—Ç.",
"–° —Ç–æ–±–æ–π —è –Ω–∞—Å—Ç–æ—è—â–∏–π.",
"–Ø —Å—á–∞—Å—Ç–ª–∏–≤, —á—Ç–æ —Ç—ã —Ä—è–¥–æ–º.",
"–¢—ã –º–æ–π –≤—ã–±–æ—Ä.",
"–Ø –ª—é–±–ª—é –Ω–∞—à–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã.",
"–¢—ã –º–æ—è –Ω–µ–∂–Ω–æ—Å—Ç—å.",
"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ç–≤–æ—ë –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ.",
"–¢—ã –º–æ–π —É—é—Ç.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ—é –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π –±–ª–∏–∑–∫–∏–π —á–µ–ª–æ–≤–µ–∫.",
"–ú–Ω–µ –≤–∞–∂–Ω–æ –±—ã—Ç—å —Ä—è–¥–æ–º.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è —Å–ø–æ–∫–æ–π–Ω—ã–º.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ–π –≥–æ–ª–æ—Å.",
"–¢—ã –º–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.",
"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω—ã —Å —Ç–æ–±–æ–π.",
"–¢—ã –º–æ—è –≥–∞—Ä–º–æ–Ω–∏—è.",
"–Ø –ª—é–±–ª—é, –∫–æ–≥–¥–∞ —Ç—ã —Å—á–∞—Å—Ç–ª–∏–≤–∞.",
"–¢—ã –º–æ–π –ª—É—á—à–∏–π —á–µ–ª–æ–≤–µ–∫.",
"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ç–≤–æ—è –¥–æ–±—Ä–æ—Ç–∞.",
"–¢—ã –º–æ–π –º–∏—Ä.",
"–Ø –ª—é–±–ª—é, —á—Ç–æ —Ç—ã –µ—Å—Ç—å.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è —Å–º–µ–ª–µ–µ.",
"–ú–Ω–µ —Å–ø–æ–∫–æ–π–Ω–æ —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π.",
"–¢—ã –º–æ—è —Ä–∞–¥–æ—Å—Ç—å –≤ –ø—Ä–æ—Å—Ç–æ–º.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ–∏ –ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏—è.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä.",
"–ú–Ω–µ –≤–∞–∂–Ω–æ —Ç–≤–æ—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–æ–∏ –¥–Ω–∏ —Å–≤–µ—Ç–ª–µ–µ.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ—é –º—è–≥–∫–æ—Å—Ç—å.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π —Ä–æ–¥–Ω–æ–π —á–µ–ª–æ–≤–µ–∫.",
"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Å–ª—ã—à–∞—Ç—å —Ç–≤–æ—ë –∏–º—è.",
"–¢—ã –º–æ—è —Ç–∏—Ö–∞—è —Ä–∞–¥–æ—Å—Ç—å.",
"–Ø –ª—é–±–ª—é –±—ã—Ç—å —Ç–≤–æ–∏–º.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π –∫—Ä–∞—Å–∏–≤—ã–π —á–µ–ª–æ–≤–µ–∫.",
"–ú–Ω–µ —Ö–æ—Ä–æ—à–æ –¥—É–º–∞—Ç—å –æ —Ç–µ–±–µ.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è —É–≤–µ—Ä–µ–Ω–Ω–µ–µ.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ—é —á–µ—Å—Ç–Ω–æ—Å—Ç—å.",
"–¢—ã –º–æ–π —Å–≤–µ—Ç–ª—ã–π —á–µ–ª–æ–≤–µ–∫.",
"–ú–Ω–µ –≤–∞–∂–Ω–æ –¥–µ–ª–∏—Ç—å—Å—è —Å —Ç–æ–±–æ–π.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–æ–∏ –≤–µ—á–µ—Ä–∞ –ª—É—á—à–µ.",
"–Ø –ª—é–±–ª—é, –∫–∞–∫ —Ç—ã —Å–º–µ—ë—à—å—Å—è.",
"–¢—ã –º–æ–π —Å–ø–æ–∫–æ–π–Ω—ã–π –æ—Å—Ç—Ä–æ–≤.",
"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ —Ç—ã —Ä—è–¥–æ–º.",
"–¢—ã –º–æ—è —Ç–∏—à–∏–Ω–∞ –≤ —à—É–º–µ.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ—ë —Ç–µ–ø–ª–æ.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π –¥–æ—Ä–æ–≥–æ–π —á–µ–ª–æ–≤–µ–∫.",
"–ú–Ω–µ –≤–∞–∂–Ω–æ —Ç–≤–æ—ë –¥–æ–≤–µ—Ä–∏–µ.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è —Å—á–∞—Å—Ç–ª–∏–≤—ã–º.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ–∏ –æ–±—ä—è—Ç–∏—è.",
"–¢—ã –º–æ–π –≥–ª–∞–≤–Ω—ã–π —á–µ–ª–æ–≤–µ–∫.",
"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Ç–µ–±—è.",
"–¢—ã –º–æ—è —Å–∏–ª–∞ –≤ –º—è–≥–∫–æ—Å—Ç–∏.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π –Ω—É–∂–Ω—ã–π —á–µ–ª–æ–≤–µ–∫.",
"–ú–Ω–µ —Å–ø–æ–∫–æ–π–Ω–æ –æ—Ç –º—ã—Å–ª–∏ –æ —Ç–µ–±–µ.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è –ª—É—á—à–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ—é –∑–∞–±–æ—Ç—É.",
"–¢—ã –º–æ–π —Å–º—ã—Å–ª –≤ –º–µ–ª–æ—á–∞—Ö.",
"–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –±—ã—Ç—å —á–∞—Å—Ç—å—é —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏.",
"–¢—ã –º–æ—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–º –¥–Ω–µ.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ—ë –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ —Ä—è–¥–æ–º.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π —Ç—ë–ø–ª—ã–π –¥–æ–º.",
"–ú–Ω–µ –≤–∞–∂–Ω–æ —Ç–≤–æ—ë —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è –º—è–≥—á–µ.",
"–Ø –ª—é–±–ª—é —Ç–≤–æ—é –Ω–µ–∂–Ω–æ—Å—Ç—å.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π —Å–≤–µ—Ç–ª—ã–π –≤—ã–±–æ—Ä.",
"–ú–Ω–µ —Ö–æ—Ä–æ—à–æ –∑–Ω–∞—Ç—å, —á—Ç–æ —Ç—ã –µ—Å—Ç—å.",
"–¢—ã –¥–µ–ª–∞–µ—à—å –º–æ—é –∂–∏–∑–Ω—å –∂–∏–≤–æ–π.",
"–Ø –ª—é–±–ª—é —Ç–µ–±—è –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫.",
]

rare_phrases = [
"–õ–∞–∑–∏–∑–∞, —è –ø—Ä–∞–≤–¥–∞ —Ö–æ—á—É –ø—Ä–æ–∂–∏—Ç—å —ç—Ç—É –∂–∏–∑–Ω—å —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π.",
"–ï—Å–ª–∏ –±—ã –º–Ω–µ –¥–∞–ª–∏ —à–∞–Ω—Å –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ, —è –±—ã —Å–Ω–æ–≤–∞ –≤—ã–±—Ä–∞–ª —Ç–µ–±—è.",
"–Ø —Ö–æ—á—É –æ–¥–Ω–∞–∂–¥—ã —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –º—ã –ø—Ä–æ—à–ª–∏ –≤—Å—ë –≤–º–µ—Å—Ç–µ.",
"–¢—ã —Ç–∞, —Å –∫–µ–º —è —Ö–æ—á—É —Å—Ç–∞—Ä–µ—Ç—å.",
"–Ø –º–µ—á—Ç–∞—é —Å—Ç—Ä–æ–∏—Ç—å —Å —Ç–æ–±–æ–π –±—É–¥—É—â–µ–µ.",
"–¢—ã –¥–ª—è –º–µ–Ω—è –±–æ–ª—å—à–µ, —á–µ–º –ø—Ä–æ—Å—Ç–æ –ª—é–±–æ–≤—å.",
"–Ø —Ö–æ—á—É –±—ã—Ç—å —Ç–µ–º, –∫—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è —Å–ø–æ–∫–æ–π–Ω–æ–π.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —á–µ–ª–æ–≤–µ–∫.",
"–Ø —Ö–æ—á—É –≤—ã–±–∏—Ä–∞—Ç—å —Ç–µ–±—è –∫–∞–∂–¥—ã–π –≥–æ–¥ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏.",
"–¢—ã –º–æ—è —Å—É–¥—å–±–∞, –≤ –∫–æ—Ç–æ—Ä—É—é —è –≤–µ—Ä—é.",
"–Ø —Ö–æ—á—É –¥–µ—Ä–∂–∞—Ç—å —Ç–µ–±—è –∑–∞ —Ä—É–∫—É —á–µ—Ä–µ–∑ –≥–æ–¥—ã.",
"–¢—ã –¥–ª—è –º–µ–Ω—è –¥–æ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –º—ã –¥–∞–ª–µ–∫–æ.",
"–Ø —Ö–æ—á—É –ø—Ä–æ–π—Ç–∏ —Å —Ç–æ–±–æ–π –≤—Å–µ —ç—Ç–∞–ø—ã –∂–∏–∑–Ω–∏.",
"–¢—ã –º–æ—è —Å–∞–º–∞—è —Å–∏–ª—å–Ω–∞—è –ª—é–±–æ–≤—å.",
"–Ø —Ö–æ—á—É –±—ã—Ç—å —Ä—è–¥–æ–º –≤ –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.",
"–¢—ã –º–æ–π –≥–ª–∞–≤–Ω—ã–π –≤—ã–±–æ—Ä –Ω–∞–≤—Å–µ–≥–¥–∞.",
"–Ø —Ö–æ—á—É, —á—Ç–æ–±—ã –º—ã –±—ã–ª–∏ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.",
"–¢—ã –º–æ–π —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Å–º—ã—Å–ª.",
"–Ø —Ö–æ—á—É —Å—Ç—Ä–æ–∏—Ç—å —Å —Ç–æ–±–æ–π –∂–∏–∑–Ω—å —à–∞–≥ –∑–∞ —à–∞–≥–æ–º.",
"–¢—ã –º–æ—è –Ω–∞–≤—Å–µ–≥–¥–∞.",
]
# ---------- –ü–ê–ú–Ø–¢–¨ ----------
def load_memory():
    if not os.path.exists(MEMORY_FILE):
        return {"clicks": 0}
    with open(MEMORY_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_memory(data):
    with open(MEMORY_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f)

memory = load_memory()

# ---------- –£–ù–ò–ö–ê–õ–¨–ù–´–ï –§–†–ê–ó–´ ----------
used_normal = []
used_rare = []

def get_unique_phrase():
    global used_normal, used_rare

    if random.random() < 0.05:
        if len(used_rare) == len(rare_phrases):
            used_rare = []
        available = list(set(rare_phrases) - set(used_rare))
        phrase = random.choice(available)
        used_rare.append(phrase)
        return "üíé –û—Å–æ–±–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n\n" + phrase

    else:
        if len(used_normal) == len(normal_phrases):
            used_normal = []
        available = list(set(normal_phrases) - set(used_normal))
        phrase = random.choice(available)
        used_normal.append(phrase)
        return phrase

def get_days_together():
    today = date.today()
    return (today - START_RELATIONSHIP).days

def get_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üíå –ü–æ–ª—É—á–∏—Ç—å –ª—é–±–æ–≤—å", callback_data="love")]
    ])

def is_allowed(chat_id):
    return chat_id == ALLOWED_CHAT_ID

# ---------- START ----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_allowed(update.effective_chat.id):
        await update.message.reply_text("–≠—Ç–æ—Ç –±–æ—Ç —Å–æ–∑–¥–∞–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –õ–∞–∑–∏–∑—ã üíñ")
        return

    days = get_days_together()

    await update.message.reply_text(
        f"–õ–∞–∑–∏–∑–∞ üíñ\n\n–°–µ–≥–æ–¥–Ω—è {days} –¥–µ–Ω—å —Å 1 –∞–≤–≥—É—Å—Ç–∞.\n\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É.",
        reply_markup=get_keyboard()
    )

# ---------- –ö–ù–û–ü–ö–ê ----------
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    chat_id = query.message.chat.id

    try:
        await query.answer()
    except:
        pass

    if not is_allowed(chat_id):
        await query.message.reply_text("–≠—Ç–æ—Ç –±–æ—Ç —Å–æ–∑–¥–∞–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –õ–∞–∑–∏–∑—ã üíñ")
        return

    memory["clicks"] += 1
    save_memory(memory)

    days = get_days_together()
    phrase = get_unique_phrase()

    text = (
        f"–û—Ç –ö–∏–º–∞–ª–∞ üíå\n\n"
        f"{phrase}\n\n"
        f"–°–µ–≥–æ–¥–Ω—è {days} –¥–µ–Ω—å –≤–º–µ—Å—Ç–µ.\n"
        f"–¢—ã –Ω–∞–∂–∏–º–∞–ª–∞ –∫–Ω–æ–ø–∫—É {memory['clicks']} —Ä–∞–∑."
    )

    await query.edit_message_text(
        text=text,
        reply_markup=get_keyboard()
    )

# ---------- –£–¢–†–û ----------
async def send_morning(context: ContextTypes.DEFAULT_TYPE):
    days = get_days_together()
    phrase = get_unique_phrase()

    await context.bot.send_message(
        chat_id=ALLOWED_CHAT_ID,
        text=f"–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –õ–∞–∑–∏–∑–∞ ‚òÄÔ∏è\n\n{phrase}\n\n–°–µ–≥–æ–¥–Ω—è {days} –¥–µ–Ω—å –≤–º–µ—Å—Ç–µ.",
        reply_markup=get_keyboard()
    )

# ---------- –í–ï–ß–ï–† ----------
async def send_evening(context: ContextTypes.DEFAULT_TYPE):
    days = get_days_together()
    phrase = get_unique_phrase()

    await context.bot.send_message(
        chat_id=ALLOWED_CHAT_ID,
        text=f"–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏, –õ–∞–∑–∏–∑–∞ üåô\n\n{phrase}\n\n–°–µ–≥–æ–¥–Ω—è {days} –¥–µ–Ω—å –≤–º–µ—Å—Ç–µ.",
        reply_markup=get_keyboard()
    )

# ---------- MAIN ----------
def main():
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_handler))

    app.job_queue.run_daily(send_morning, MORNING_TIME)
    app.job_queue.run_daily(send_evening, EVENING_TIME)

    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å –ø–∞–º—è—Ç—å—é –∏ —Å—á—ë—Ç—á–∏–∫–æ–º –¥–Ω–µ–π.")
    app.run_polling()

if __name__ == "__main__":
    main()